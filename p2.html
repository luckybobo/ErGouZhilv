<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡ç”Ÿä¹‹æˆ‘æ˜¯äºŒç‹—ä¹‹å‰å¾€äºŒä¸ƒæ‹¯æ•‘ç¾å¥³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #1a3e4a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
        }
        .game-wrapper {
            background: #2d6d84;
            padding: 15px;
            border-radius: 36px;
            box-shadow: 0 15px 20px rgba(0,0,0,0.7);
            position: relative;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 28px;
            background: #b5def5;
            box-shadow: inset 0 -5px 0 #3d7188, 0 10px 10px rgba(0,0,0,0.5);
            touch-action: none;
        }
        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 8px 8px;
            color: #f7eac5;
            text-shadow: 2px 2px 0 #123845;
            font-weight: bold;
            font-size: 1.2rem;
            flex-wrap: wrap;
            gap: 10px;
        }
        .hud-item {
            background: #2a3b35;
            padding: 5px 18px;
            border-radius: 50px;
            border: 2px solid #fbb37c;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .mobile-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 8px 0 5px;
            flex-wrap: wrap;
        }
        .mobile-row button {
            padding: 8px 20px;
            font-size: 1.6rem;
            background: #d9efff;
            border: 3px solid #ffffcf;
            border-radius: 60px;
            box-shadow: 0 6px 0 #356882, 0 6px 10px black;
            transition: 0.03s linear;
            touch-action: manipulation;
            font-weight: bold;
            color: #134257;
            min-width: 80px;
        }
        .mobile-row button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #356882, 0 4px 8px black;
        }
        .action-bar {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .action-bar button {
            flex: 1;
            background: #f5cf8b;
            border: none;
            border-radius: 45px;
            padding: 10px 8px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #103f4f;
            box-shadow: 0 5px 0 #8b6d44, 0 5px 10px black;
            min-width: 90px;
        }
        .action-bar button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #8b6d44, 0 4px 8px black;
        }
        /* èœå•é®ç½© */
        .menu-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .menu-panel {
            background: #3f7a8c;
            padding: 25px;
            border-radius: 50px;
            border: 6px solid #fedb9f;
            box-shadow: 0 20px 30px black;
            min-width: 320px;
            max-width: 90%;
            color: #fef6d2;
            font-weight: bold;
            max-height: 80vh;
            overflow-y: auto;
        }
        .menu-panel h2 {
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 3px 3px 0 #1d4455;
        }
        .menu-panel h3 {
            font-size: 1.8rem;
            margin: 15px 0 10px;
        }
        .menu-panel button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            font-size: 1.4rem;
            border-radius: 50px;
            border: none;
            background: #f5cf8b;
            color: #134d5e;
            font-weight: bold;
            box-shadow: 0 5px 0 #8b6d44;
        }
        .menu-panel button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #8b6d44;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            font-size: 1.3rem;
        }
        .setting-item input[type=range] {
            width: 150px;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            font-size: 1.2rem;
            background: #2f5f70;
            padding: 8px 15px;
            border-radius: 40px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .shop-item button {
            width: auto;
            padding: 5px 20px;
            margin: 0;
            font-size: 1.2rem;
        }
        .level-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        .level-btn {
            padding: 20px 10px;
            font-size: 1.3rem;
            background: #5f9ea0;
            border: 4px solid #ffd966;
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .level-btn.locked {
            background: #5a5a5a;
            border-color: #888;
            opacity: 0.7;
        }
        .level-stars {
            font-size: 1.2rem;
            color: #ffd966;
        }
        .story-text {
            font-size: 1.2rem;
            line-height: 1.8;
            margin: 20px 0;
            text-align: center;
            white-space: pre-line;
        }
        .boss-hp-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border: 3px solid #ffd966;
            border-radius: 15px;
            margin: 10px 0;
            overflow: hidden;
        }
        .boss-hp-fill {
            height: 100%;
            background: #ff4444;
            width: 100%;
            transition: width 0.3s;
        }
        @media (max-width: 600px) {
            .hud { font-size: 1rem; }
            .mobile-row button { padding: 8px 12px; font-size: 1.4rem; }
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <canvas id="gameCanvas" width="1200" height="550"></canvas>
    <div class="hud">
        <div class="hud-item">â¤ï¸ <span id="hpDisplay">5</span>/<span id="maxHpDisplay">5</span></div>
        <div class="hud-item">ğŸ‘‹ <span id="atkDisplay">1</span></div>
        <div class="hud-item">ğŸ’© <span id="coinDisplay">0</span></div>
        <div class="hud-item">ğŸ– <span id="starDisplay">0</span>/<span id="totalStarsDisplay">20</span></div>
        <div class="hud-item">ğŸ—ºï¸ ç¬¬ <span id="levelDisplay">1</span> å…³</div>
        <div id="messageBox" style="background:#2e2b1a; padding:5px 20px; border-radius:40px;">èœå•ä¸­</div>
    </div>
    <div class="mobile-row">
        <button id="btnL">â—€ å·¦</button>
        <button id="btnJ">â–² äºŒæ®µè·³</button>
        <button id="btnR">å³ â–¶</button>
        <button id="btnAttack"></button>
    </div>
    <div class="action-bar">
        <button id="jumpBig">ğŸ¦˜ è·³è·ƒ (ç©ºæ ¼/â†‘)</button>
        <button id="attackBig">ğŸ‘‹ å‡ºæ´ (J)</button>
        <button id="menuBtn">ğŸ“± èœå•</button>
        <button id="restartBtn">ğŸ”„ é‡ç©</button>
    </div>
</div>

<!-- å‰§æƒ…å±•ç¤º -->
<div class="menu-overlay" id="storyOverlay" style="display:flex;">
    <div class="menu-panel">
        <h2>é‡ç”Ÿä¹‹æˆ‘æ˜¯äºŒç‹—ä¹‹å‰å¾€äºŒä¸ƒæ‹¯æ•‘ç¾å¥³</h2>
        <div class="story-text" id="storyText"></div>
        <button id="storyNextBtn">ç»§ç»­</button>
    </div>
</div>

<!-- ä¸»èœå• -->
<div class="menu-overlay" id="menuOverlay">
    <div class="menu-panel">
        <h2>ğŸ é‡ç”Ÿä¹‹æˆ‘æ˜¯äºŒç‹—ä¹‹å‰å¾€äºŒä¸ƒæ‹¯æ•‘ç¾å¥³</h2>
        <button id="startGameBtn">â–¶ å¼€å§‹æ¸¸æˆ (ç¬¬1å…³)</button>
        <button id="levelSelectBtn">ğŸ—ºï¸ é€‰æ‹©å…³å¡</button>
        <button id="shopBtnMain">ğŸ›’ å•†åº—</button>
        <button id="settingsBtnMain">âš™ï¸ è®¾ç½®</button>
        <button id="closeMenuBtn">âœ– å…³é—­èœå•</button>
    </div>
</div>

<!-- å…³å¡é€‰æ‹© -->
<div class="menu-overlay" id="levelSelectOverlay">
    <div class="menu-panel">
        <h2>ğŸ—ºï¸ é€‰æ‹©å…³å¡</h2>
        <div class="level-select" id="levelButtons"></div>
        <button id="backFromLevels">ğŸ”™ è¿”å›</button>
    </div>
</div>

<!-- é€šå…³æ€»ç»“ -->
<div class="menu-overlay" id="completionOverlay">
    <div class="menu-panel">
        <h2>ğŸ‰ ä½ æŠµè¾¾äº†äºŒä¸ƒï¼</h2>
        <div class="completion-panel" id="completionMessage"></div>
        <button id="continueBtn">ç»§ç»­</button>
    </div>
</div>

<!-- å•†åº— -->
<div class="menu-overlay" id="shopOverlay">
    <div class="menu-panel">
        <h2>ğŸ›’ åŠå…¬å®¤ (ç™½å±: <span id="shopCoin">0</span>)</h2>
        <div class="shop-item">
            <span>â¤ï¸ æœ€å¤§è¡€é‡ +1</span>
            <span>10 ğŸ’©</span>
            <button id="buyHpBtn">è´­ä¹°</button>
        </div>
        <div class="shop-item">
            <span>âš”ï¸ æ´åŠ› +1</span>
            <span>15 ğŸ’©</span>
            <button id="buyAtkBtn">è´­ä¹°</button>
        </div>
        <div class="shop-item">
            <span>ğŸ’Š å›å¤1â¤ï¸</span>
            <span>8 ğŸ’©</span>
            <button id="buyHealBtn">è´­ä¹°</button>
        </div>
        <button id="backFromShop">ğŸ”™ è¿”å›</button>
    </div>
</div>

<!-- è®¾ç½® -->
<div class="menu-overlay" id="settingsOverlay">
    <div class="menu-panel">
        <h2>âš™ï¸ è®¾ç½®</h2>
        <div class="setting-item">
            <span>ğŸ® éš¾åº¦</span>
            <select id="difficultySelect">
                <option value="1">ç®€å•</option>
                <option value="2" selected>æ™®é€š</option>
                <option value="3">å›°éš¾</option>
            </select>
        </div>
        <div class="setting-item">
            <span>ğŸ”Š ä¸»éŸ³é‡</span>
            <input type="range" id="masterVolume" min="0" max="100" value="0">
        </div>
        <div class="setting-item">
            <span>ğŸ”Š éŸ³æ•ˆéŸ³é‡</span>
            <input type="range" id="sfxVolume" min="0" max="100" value="0">
        </div>
        <button id="backFromSettings">ğŸ”™ è¿”å›</button>
    </div>
</div>

<!-- Bossæˆ˜èƒœåˆ©ç»“å±€ -->
<div class="menu-overlay" id="endingOverlay">
    <div class="menu-panel">
        <h2>ğŸ‰ å¤§å›¢åœ†ç»“å±€ ğŸ‰</h2>
        <div class="story-text">
            äºŒç‹—æ‰“è´¥äº†é˜¿åŠ›å’Œå¤§ç¯ï¼Œæ•‘å‡ºäº†ç¾ä¸½çš„æ¯ç‹—ï¼<br>
            ä»–ä»¬å›åˆ°äº†æ²§å¿ä¸­å­¦ï¼Œè¿‡ä¸Šäº†å¹¸ç¦çš„ç”Ÿæ´»ã€‚<br><br>
            ğŸ‘‘ æ„Ÿè°¢æ‚¨çš„æ¸¸ç©å’Œè§è¯è¿™ç¾ä¸½çš„æ•…äº‹ï¼ ğŸ‘¸ <br>
            åˆ¶ä½œ 81rewot 
        </div>
        <button id="endingContinueBtn">è¿”å›èœå•</button>
    </div>
</div>

<script>
(function(){
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    // æ˜¾ç¤ºå…ƒç´ 
    const hpSpan = document.getElementById('hpDisplay');
    const maxHpSpan = document.getElementById('maxHpDisplay');
    const atkSpan = document.getElementById('atkDisplay');
    const coinSpan = document.getElementById('coinDisplay');
    const starSpan = document.getElementById('starDisplay');
    const totalStarsSpan = document.getElementById('totalStarsDisplay');
    const levelSpan = document.getElementById('levelDisplay');
    const msgBox = document.getElementById('messageBox');

    // èœå•å…ƒç´ 
    const storyOverlay = document.getElementById('storyOverlay');
    const storyText = document.getElementById('storyText');
    const storyNextBtn = document.getElementById('storyNextBtn');
    const menuOverlay = document.getElementById('menuOverlay');
    const levelSelectOverlay = document.getElementById('levelSelectOverlay');
    const completionOverlay = document.getElementById('completionOverlay');
    const completionMessage = document.getElementById('completionMessage');
    const shopOverlay = document.getElementById('shopOverlay');
    const settingsOverlay = document.getElementById('settingsOverlay');
    const endingOverlay = document.getElementById('endingOverlay');
    const shopCoinSpan = document.getElementById('shopCoin');
    const levelButtonsDiv = document.getElementById('levelButtons');

    // æŒ‰é’®
    const startBtn = document.getElementById('startGameBtn');
    const levelSelectBtn = document.getElementById('levelSelectBtn');
    const shopBtnMain = document.getElementById('shopBtnMain');
    const settingsBtnMain = document.getElementById('settingsBtnMain');
    const closeMenu = document.getElementById('closeMenuBtn');
    const backFromLevels = document.getElementById('backFromLevels');
    const backFromShop = document.getElementById('backFromShop');
    const backFromSettings = document.getElementById('backFromSettings');
    const continueBtn = document.getElementById('continueBtn');
    const endingContinueBtn = document.getElementById('endingContinueBtn');
    const buyHp = document.getElementById('buyHpBtn');
    const buyAtk = document.getElementById('buyAtkBtn');
    const buyHeal = document.getElementById('buyHealBtn');
    const difficultySelect = document.getElementById('difficultySelect');
    const masterVolume = document.getElementById('masterVolume');
    const sfxVolume = document.getElementById('sfxVolume');
    const menuButton = document.getElementById('menuBtn');
    const restartBtn = document.getElementById('restartBtn');

    // ç”»å¸ƒå°ºå¯¸
    const W = 1200, H = 550;
    canvas.width = W; canvas.height = H;
    const GROUND_Y = H - 70;

    // ç‰©ç†å‚æ•° - ä¼˜åŒ–äºŒæ®µè·³æ‰‹æ„Ÿ
    const GRAVITY = 0.45;  // é™ä½é‡åŠ›ï¼Œæ›´å®¹æ˜“æ§åˆ¶
    const JUMP_FORCE = -12.5;  // æ›´å¼ºçš„è·³è·ƒåŠ›
    const DOUBLE_JUMP_FORCE = -10.5;  // æ›´å¼ºçš„äºŒæ®µè·³
    const MOVE_SPEED = 5.5;  // ç¨å¾®æé«˜ç§»åŠ¨é€Ÿåº¦
    const MAX_FALL = 13;

    // éŸ³æ•ˆç³»ç»Ÿ
    let audioCtx = null;
    let masterGain = null;
    let sfxGain = null;

    const playerImg = new Image();
    playerImg.src = 'ergo.png';
    const bossImg = new Image();
    bossImg.src = 'ergo2.png';
    const starImg = new Image();
    starImg.src = 'meat1.png';
    const handImg = new Image();
    handImg.src = 'hand.png';
    const shitImg = new Image();
    shitImg.src = 'shit.png';
    
    function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        sfxGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);
        sfxGain.connect(masterGain);
        masterGain.gain.value = 0;
        sfxGain.gain.value = 0;
    }

    function playSound(type) {
        if (!audioCtx || !sfxGain) return;
        if (masterGain.gain.value === 0 || sfxGain.gain.value === 0) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        osc.connect(gainNode);
        gainNode.connect(sfxGain);
        
        let freq = 440;
        let duration = 0.1;
        
        switch(type) {
            case 'jump': freq = 523.25; duration = 0.15; break;
            case 'doubleJump': freq = 659.25; duration = 0.2; break;
            case 'attack': freq = 220; duration = 0.1; break;
            case 'kill': freq = 110; duration = 0.3; break;
            case 'coin': freq = 783.99; duration = 0.1; break;
            case 'hurt': freq = 174.61; duration = 0.2; break;
            case 'buy': freq = 659.25; duration = 0.2; break;
            case 'bossHurt': freq = 82.41; duration = 0.3; break;
            case 'levelComplete':
                freq = 523.25;
                setTimeout(() => {
                    const osc2 = audioCtx.createOscillator();
                    const gain2 = audioCtx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(sfxGain);
                    osc2.frequency.value = 659.25;
                    gain2.gain.value = 0.2;
                    osc2.start();
                    osc2.stop(audioCtx.currentTime + 0.15);
                }, 150);
                break;
        }
        
        osc.frequency.value = freq;
        gainNode.gain.value = 0.2;
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
        
        setTimeout(() => {
            osc.disconnect();
            gainNode.disconnect();
        }, duration * 1000);
    }
    

    // å‰§æƒ…æ–‡æœ¬
    const storyParts = [
        "å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œåœ¨æ²§å¿ä¸­å­¦é‡Œ...ğŸ˜ƒ",
        "ç”Ÿæ´»ç€ä¸€åªæ¯ç‹—å’Œä¸€åªäºŒç‹—â¤ï¸ğŸ’•",
        "ç¾ä¸½çš„æ¯ç‹—è¢«é‚ªæ¶çš„é˜¿åŠ›åˆ°äº†å››é£Ÿå ‚ï¼ğŸ˜­",
        "å‹‡æ•¢çš„äºŒç‹—å†³å®šè¸ä¸Šæ‹¯æ•‘æ¯ç‹—çš„å¾ç¨‹ã€‚ğŸ˜¡",
        "ç¥åœ£çš„ä¸™å‹ç»™äºˆäº†äºŒç‹—æ‹å­ï¼Œ\nä½ å¯ä»¥ç”¨æ´å­æ¥å¯¹æ•Œäººé€ æˆä¼¤å®³ğŸ˜¶â€ğŸŒ«ï¸",
        "ä¼Ÿå¤§çš„æ˜å³°ç»™äºˆäº†äºŒç‹— ç™½å±ğŸ’©å’Œçº¢è‚‰ğŸ– ï¼Œ\nçº¢è‚‰ğŸ–æ˜¯ä½ æˆåŠŸçš„è±¡å¾ï¼Œ\nè€Œç™½å±ğŸ’©å¯ä»¥åœ¨åŠå…¬å®¤è´­ä¹°æ›´å¤šåŠ æˆï¼",
        "æ¥ä¸‹æ¥ï¼Œä»–éœ€è¦ç©¿è¶Šä¸‰ä¸ªå±é™©çš„åœ°ç‚¹ï¼Œåˆ†åˆ«æ˜¯ \né«˜ä¸‰æ•™å­¦æ¥¼ğŸ˜¯ \næ“åœºğŸ˜¥ \nå››é£Ÿå ‚ğŸ˜¨ ",
        "æ”¶é›†ç™½å±ï¼Œæå‡å®åŠ›ï¼Œ\næœ€ç»ˆæŒ‘æˆ˜ä¼ªè£…æˆæ¯ç‹—çš„å¤§ç¯Bossï¼\nå¹¶ä»é˜¿åŠ›æ‰‹ä¸­æ•‘å‡ºæ¯ç‹—ï¼ğŸ¥¶",
        "å‡†å¤‡å¥½å¼€å§‹å†’é™©äº†å—ï¼ŸğŸ¦"
    ];
    let storyIndex = 0;

    function showNextStory() {
        if(storyIndex < storyParts.length) {
            storyText.innerText = storyParts[storyIndex];
            storyIndex++;
        } else {
            storyOverlay.style.display = 'none';
            menuOverlay.style.display = 'flex';
        }
    }

    storyNextBtn.addEventListener('click', showNextStory);

    // å…³å¡æ•°æ®
    const levels = [
        { 
            id: 1, 
            name: 'åˆçº§ é«˜ä¸‰æ•™å­¦æ¥¼', 
            worldWidth: 15000,
            goalX: 14500,
            stars: 20,
            baseEnemyHp: 2,
            basePlatforms: 'normal',
            unlocked: true  // ç¬¬ä¸€å…³é»˜è®¤è§£é”
        },
        { 
            id: 2, 
            name: 'ä¸­çº§ æ“åœº', 
            worldWidth: 21000,
            goalX: 20500,
            stars: 25,
            baseEnemyHp: 3,
            basePlatforms: 'advanced',
            unlocked: false
        },
        { 
            id: 3, 
            name: 'æœ€ç»ˆ <<å››é£Ÿå ‚>>(é˜¿åŠ›å’Œå¤§ç¯çš„æ‰€åœ¨åœ°)', 
            worldWidth: 27000,
            goalX: 26500,
            stars: 30,
            baseEnemyHp: 4,
            basePlatforms: 'expert',
            unlocked: true,
            hasBoss: true  // ç¬¬ä¸‰å…³æœ‰Boss
        }
    ];
    
    let levelStarsCollected = {
        1: 0,
        2: 0,
        3: 0
    };

    // Boss å®ä½“
    let boss = null;

    let currentLevel = 1;
    let WORLD_WIDTH = 15000;
    let GOAL_X = 14500;

    // ç©å®¶å±æ€§
    let player = {
        x: 150, y: GROUND_Y - 55,
        w: 60, h: 60,
        vx: 0, vy: 0,
        onGround: false,
        doubleJumpUsed: false,
        dir: 1,
        hp: 1000,
        maxHp: 1000,
        atk: 1,
        coins: 10,
        invincible: 0,
        attacking: false,
        attackTimer: 0
    };
    let hand = {
        w: 60, h: 60,
    };

    // æ¸¸æˆå…ƒç´ 
    let stars = [];
    let platforms = [];
    let obstacles = [];
    let enemies = [];
    let coins = [];

    // ç”Ÿæˆå…³å¡æ•°æ®
    function generateLevel(levelId) {
        const level = levels.find(l => l.id === levelId) || levels[0];
        WORLD_WIDTH = level.worldWidth;
        GOAL_X = level.goalX;
        
        // é‡ç½®Boss
        boss = null;
        
        // å±
        stars = [];
        for(let i=0; i<level.stars; i++) {
            let x = 300 + i * (WORLD_WIDTH-1000)/level.stars;
            if(x > GOAL_X-300) x = GOAL_X-400;
            stars.push({ 
                x: x, 
                y: GROUND_Y-120 - (i%4)*30,  
                w: 50, h: 40, 
                got: false 
            });
        }
        totalStarsSpan.innerText = stars.length;

        // å¹³å° 
        platforms = [
            { x: 0, y: GROUND_Y, w: WORLD_WIDTH, h: 70, type: 'normal' }
        ];

        const platformCount = levelId === 1 ? 20 : (levelId === 2 ? 30 : 40);
        for(let i=0; i<platformCount; i++) {
            let x = 400 + i * 600 + Math.random()*300;
            if(x > GOAL_X-500) break;
            
            let y = GROUND_Y - 100 - Math.random() * 150;
            if(y < 150) y = 200;
            
            let type = 'normal';
            
            if(levelId >= 2) {
                let rand = Math.random();
                if(rand < 0.2) type = 'bounce';
                else if(rand < 0.3) type = 'break';
                else if(rand < 0.4) type = 'moving';
            }
            if(levelId >= 3) {
                let rand = Math.random();
                if(rand < 0.25) type = 'bounce';
                else if(rand < 0.4) type = 'break';
                else if(rand < 0.5) type = 'moving';
            }
            
            platforms.push({
                x: x, y: y, w: 120 + Math.random()*80, h: 20,  // åŠ å®½å¹³å°
                type: type,
                bounceFactor: type === 'bounce' ? 1.8 : undefined,
                broken: false,
                baseX: type === 'moving' ? x : undefined,
                moveRange: type === 'moving' ? 200 : undefined,
                speed: type === 'moving' ? 1 : undefined,
                dir: type === 'moving' ? 1 : undefined
            });
        }

        // éšœç¢ç‰©
        obstacles = [];
        const obstacleCount = levelId * 6;
        for(let i=0; i<obstacleCount; i++) {
            let x = 500 + i * 1500 + Math.random()*500;
            if(x > GOAL_X-300) break;
            let rh = Math.random()*100
            obstacles.push({
                x: x,
                y: GROUND_Y-45-rh,
                w: 60 + Math.random()*60,
                h: 45+rh
            });
        }

        // æ•Œäºº
        enemies = [];
        const enemyCount = levelId * 6;
        for(let i=0; i<enemyCount; i++) {
            let x = 400 + i * 1200 + Math.random()*500;
            if(x > GOAL_X-500) break;
            
            let type = 'walker';
            if(levelId >= 2) {
                let rand = Math.random();
                if(rand < 0.3) type = 'jumper';
                else if(rand < 0.5) type = 'flyer';
            }
            if(levelId >= 3) {
                let rand = Math.random();
                if(rand < 0.35) type = 'jumper';
                else if(rand < 0.6) type = 'flyer';
            }
            
            let hp = level.baseEnemyHp * difficulty;
            if(type === 'jumper') hp = Math.floor(hp * 1.5);
            if(type === 'flyer') hp = Math.floor(hp * 2);
            
            // å¢å¤§æ•Œäººå°ºå¯¸
            let size = type === 'flyer' ? 48 : (type === 'jumper' ? 62 : 115);
            
            enemies.push({
                x: x,
                y: type === 'flyer' ? 200 + Math.random()*150 : GROUND_Y - size - 5,
                w: type === 'flyer' ? 38 : (type === 'jumper' ? 40 : 70),
                h: size,
                type: type,
                hp: hp,
                maxHp: hp,
                vx: type === 'flyer' ? 2.0 : (1.0 + Math.random()*0.6),
                vy: 0,
                dir: Math.random() > 0.5 ? 1 : -1,
                active: true,
                jumpCd: 0
            });
        }

        // ç¬¬ä¸‰å…³æ·»åŠ Boss
        if(level.hasBoss) {
            boss = {
                x: GOAL_X - 400,
                y: GROUND_Y - 300,
                w: 250,
                h: 270,
                hp: 50 * difficulty,
                maxHp: 50 * difficulty,
                phase: 1,
                attackTimer: 0,
                active: true,
                invincible: 0
            };
        }

        coins = [];
    }

    initAudio();

    // UIæ›´æ–°
    function updateUI() {
        let starCnt = stars.filter(s=>s.got).length;
        starSpan.innerText = starCnt;
        totalStarsSpan.innerText = stars.length;
        hpSpan.innerText = player.hp;
        maxHpSpan.innerText = player.maxHp;
        atkSpan.innerText = player.atk;
        coinSpan.innerText = player.coins;
        levelSpan.innerText = currentLevel;
    }

    // é‡ç½®å½“å‰å…³å¡
    function resetGame() {
        gameActive = true;
        gameWin = false;
        gameOver = false;
        
        player.x = 150;
        player.y = GROUND_Y - 55;
        player.vx = 0;
        player.vy = 0;
        player.hp = player.maxHp;
        player.invincible = 0;
        player.attacking = false;
        player.attackTimer = 0;
        player.doubleJumpUsed = false;
        
        generateLevel(currentLevel);
        updateUI();
        msgBox.innerText = 'å…³å¡ ' + currentLevel;
        msgBox.style.background = '#2e2b1a';
    }

    // é€šå…³å¤„ç†
    function handleLevelComplete() {
        gameWin = true;
        gameActive = false;
        
        let collected = stars.filter(s=>s.got).length;
        let total = stars.length;
        
        // æ›´æ–°æœ¬å…³æ”¶é›†è®°å½•
        if(collected > levelStarsCollected[currentLevel]) {
            levelStarsCollected[currentLevel] = collected;
        }
        
        // æ˜¾ç¤ºé€šå…³æ€»ç»“
        completionMessage.innerHTML = `
            <p>ç¬¬ ${currentLevel} å…³ å®Œæˆï¼</p>
            <p>ğŸ– æœ¬å…³æ”¶é›†: ${collected}/${total}</p>
            <p>ğŸ’© è·å¾—ç™½å±: ${Math.floor(collected/2)}</p>
        `;
        
        // å¥–åŠ±é‡‘å¸
        player.coins += Math.floor(collected);
        updateUI();
        
        // è§£é”ä¸‹ä¸€å…³ (ä½†ä¿ç•™ç¬¬ä¸€å…³å§‹ç»ˆå¯ç©)
        if (currentLevel < levels.length) {
            levels[currentLevel].unlocked = true;
        }
        
        completionOverlay.style.display = 'flex';
        playSound('levelComplete');
    }

    // Bossæˆ˜å¤„ç†
    function updateBoss() {
        if(!boss || !boss.active) return;
        
        // Bossæ”»å‡»æ¨¡å¼
        boss.attackTimer--;
        if(boss.attackTimer <= 0) {
            // å‘å°„ç«çƒï¼ˆç®€å•å®ç°ï¼Œåªæ˜¯é è¿‘ç©å®¶ï¼‰
            boss.attackTimer = 60;
        }
        
        // Bossç§»åŠ¨
        if(boss.phase === 1) {
            boss.x += Math.sin(Date.now() * 0.002) * 2;
        } else {
            boss.x += Math.sin(Date.now() * 0.003) * 3;
            boss.y += Math.cos(Date.now() * 0.002) * 1;
        }
        
        // Bossä¸ç©å®¶ç¢°æ’
        if(player.x < boss.x + boss.w && player.x + player.w > boss.x &&
           player.y < boss.y + boss.h && player.y + player.h > boss.y) {
            if(player.invincible === 0) {
                player.hp -= 2;
                player.invincible = 40;
                playSound('hurt');
                if(player.hp <= 0) {
                    gameActive = false;
                    gameOver = true;
                    msgBox.innerText = 'ğŸ’€ è¢«å¤§ç¯å‡»è´¥';
                }
            }
        }
        
        // ç©å®¶æ”»å‡»Boss
        if(player.attacking && boss.invincible === 0) {
            if(Math.abs(player.x + player.w/2 - (boss.x + boss.w/2)) < 100 &&
               Math.abs(player.y + player.h/2 - (boss.y + boss.h/2)) < 100) {
                boss.hp -= player.atk;
                boss.invincible = 20;
                playSound('bossHurt');
                
                // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
                if(boss.hp < boss.maxHp / 2 && boss.phase === 1) {
                    boss.phase = 2;
                }
                
                if(boss.hp <= 0) {
                    boss.active = false;
                    // Bossæ­»äº¡ï¼Œé€šå…³
                    gameWin = true;
                    gameActive = false;
                    endingOverlay.style.display = 'flex';
                    playSound('levelComplete');
                }
            }
        }
        
        if(boss.invincible > 0) boss.invincible--;
    }

    // è´­ä¹°
    function buyItem(type) {
        if(!gameActive) return;
        if(type==='hp' && player.coins>=10) {
            player.maxHp += 1;
            player.hp += 1;
            player.coins -= 10;
            playSound('buy');
        } else if(type==='atk' && player.coins>=15) {
            player.atk += 1;
            player.coins -= 15;
            playSound('buy');
        } else if(type==='heal' && player.coins>=8 && player.hp < player.maxHp) {
            player.hp = Math.min(player.maxHp, player.hp+1);
            player.coins -= 8;
            playSound('buy');
        }
        updateUI();
        shopCoinSpan.innerText = player.coins;
    }

    // æ”»å‡»æ£€æµ‹
    function performAttack() {
        if(!gameActive || player.attacking) return;
        player.attacking = true;
        player.attackTimer = 10;
        playSound('attack');
        
        let attackRange = 60;  // å¢åŠ æ”»å‡»èŒƒå›´
        
        // æ”»å‡»æ™®é€šæ•Œäºº
        for(let i=0; i<enemies.length; i++) {
            let e = enemies[i];
            if(!e.active) continue;
            let dx = player.dir===1 ? (e.x - (player.x+player.w)) : (player.x - (e.x+e.w));
            if(Math.abs(dx) < attackRange && Math.abs(e.y - player.y) < 80) {
                e.hp -= player.atk;
                if(e.hp <= 0) {
                    e.active = false;
                    coins.push({ x: e.x+e.w/2, y: e.y+e.h/2, w: 50, h: 40, value: 8 });  // æ›´å¤§é‡‘å¸
                    playSound('kill');
                }
            }
        }
    }

    // è·³è·ƒ - ä¼˜åŒ–æ‰‹æ„Ÿ
    function doJump() {
        if(!gameActive) return;
        if(player.onGround) {
            player.vy = JUMP_FORCE;
            player.onGround = false;
            player.doubleJumpUsed = false;
            playSound('jump');
        } else if(!player.doubleJumpUsed) {
            player.vy = DOUBLE_JUMP_FORCE;
            player.doubleJumpUsed = true;
            playSound('doubleJump');
        }
    }

    // æ›´æ–°æ•Œäºº AI
    function updateEnemies() {
        for(let e of enemies) {
            if(!e.active) continue;
            if(e.type==='walker' || e.type==='jumper') {
                e.x += e.vx * e.dir;
                if(e.x < 100 || e.x > WORLD_WIDTH-100) e.dir *= -1;
            } else if(e.type==='flyer') {
                e.x += e.vx * e.dir;
                e.y += Math.sin(Date.now()*0.01)*0.8;
                if(e.x < 100 || e.x > WORLD_WIDTH-100) e.dir *= -1;
            }
            if(e.type!=='flyer') {
                e.vy += GRAVITY*0.9;
                e.y += e.vy;
                if(e.y+e.h > GROUND_Y) { e.y = GROUND_Y-e.h; e.vy=0; }
            }
            if(e.type==='jumper' && e.jumpCd<=0 && Math.random()<0.008) {
                e.vy = -10; e.jumpCd = 50;
            }
            if(e.jumpCd>0) e.jumpCd--;
        }
    }

    // æ”¶é›†é‡‘å¸
    function collectCoins() {
        for(let i=coins.length-1; i>=0; i--) {
            let c = coins[i];
            if(player.x < c.x+c.w && player.x+player.w > c.x &&
               player.y < c.y+c.h && player.y+player.h > c.y) {
                player.coins += c.value;
                coins.splice(i,1);
                playSound('coin');
                updateUI();
            }
        }
    }

    // ç‰©ç†æ›´æ–°
    function updateGame() {
        if(!gameActive) return;
        if(player.invincible>0) player.invincible--;
        if(player.attackTimer>0) player.attackTimer--; else player.attacking=false;

        if(left) { player.vx = -MOVE_SPEED; player.dir = -1; }
        else if(right) { player.vx = MOVE_SPEED; player.dir = 1; }
        else player.vx = 0;

        player.x += player.vx;
        player.x = Math.max(15, Math.min(WORLD_WIDTH-player.w-15, player.x));

        player.vy += GRAVITY;
        if(player.vy > MAX_FALL) player.vy = MAX_FALL;
        player.y += player.vy;

        // å¹³å°ç¢°æ’
        player.onGround = false;
        for(let pl of platforms) {
            if(pl.type==='break' && pl.broken) continue;
            if(pl.type==='moving') {
                pl.x = pl.baseX + Math.sin(Date.now()*0.005*pl.speed)*pl.moveRange;
            }
            if(player.x < pl.x+pl.w && player.x+player.w > pl.x) {
                let pBot = player.y+player.h;
                if(pBot >= pl.y && pBot <= pl.y+pl.h+5 && player.vy>=0) {
                    player.y = pl.y - player.h;
                    player.vy = 0;
                    player.onGround = true;
                    player.doubleJumpUsed = false;
                    if(pl.type === 'bounce') {
                        player.vy = JUMP_FORCE * 1.8;
                        player.onGround = false;
                    } else if(pl.type === 'break') {
                        pl.broken = true;
                    }
                }
            }
        }
        if(player.y+player.h > GROUND_Y) {
            player.y = GROUND_Y - player.h;
            player.vy = 0;
            player.onGround = true;
            player.doubleJumpUsed = false;
        }

        updateEnemies();
        collectCoins();

        // æ•Œäººç¢°æ’ä¼¤å®³
        for(let e of enemies) {
            if(!e.active) continue;
            if(player.x < e.x+e.w && player.x+player.w > e.x &&
               player.y < e.y+e.h && player.y+player.h > e.y) {
                if(player.invincible===0) {
                    player.hp -= 1;
                    player.invincible = 40;
                    playSound('hurt');
                    if(player.hp<=0) { 
                        gameActive=false; 
                        gameOver=true; 
                        msgBox.innerText='ğŸ’€ ä½ çš„äºŒç‹—ç²¾å°½è€Œäº¡äº†!'; 
                    }
                }
            }
        }

        // éšœç¢ç‰©
        for(let ob of obstacles) {
            if(player.x < ob.x+ob.w && player.x+player.w > ob.x &&
               player.y < ob.y+ob.h && player.y+player.h > ob.y) {
                if(player.invincible===0) {
                    player.hp -= 1;
                    player.invincible = 40;
                    playSound('hurt');
                    if(player.hp<=0) { 
                        gameActive=false; 
                        gameOver=true; 
                        msgBox.innerText='ğŸ’€ ä½ çš„äºŒç‹—ç²¾å°½è€Œäº¡äº†!'; 
                    }
                }
            }
        }

        // Bossæˆ˜
        if(boss && boss.active) {
            updateBoss();
        }

        // çº¢è‚‰æ”¶é›†
        for(let s of stars) {
            if(!s.got && player.x < s.x+s.w && player.x+player.w > s.x && 
               player.y < s.y+s.h && player.y+player.h > s.y) { 
                s.got=true; 
                playSound('coin');
                updateUI(); 
            }
        }

        // ç»ˆç‚¹ (å¦‚æœæ²¡æœ‰Bossæˆ–è€…Bosså·²è¢«å‡»è´¥)
        if(!boss || !boss.active) {
            if(!gameWin && player.x+player.w > GOAL_X) { 
                handleLevelComplete();
            }
        }
        
        updateUI();
    }

    // ç»˜åˆ¶
    function draw() {
        ctx.clearRect(0,0,W,H);
        let targetCam = player.x - 500;
        targetCam = Math.max(0, Math.min(targetCam, WORLD_WIDTH-W));
        cameraX = targetCam;
        ctx.save(); ctx.translate(-cameraX,0);

        ctx.fillStyle = '#b0daf0'; ctx.fillRect(cameraX,0,W,H);
        
        // å¹³å°
        for(let pl of platforms) {
            if(pl.type==='break' && pl.broken) continue;
            if(pl.type==='bounce') ctx.fillStyle = '#f0a55a';
            else if(pl.type==='break') ctx.fillStyle = '#a9a9a9';
            else if(pl.type==='moving') ctx.fillStyle = '#7ac78c';
            else ctx.fillStyle = '#7f9faf';
            ctx.fillRect(pl.x, pl.y, pl.w, pl.h);
        }
        
        // éšœç¢ç‰©
        ctx.fillStyle = '#a55'; 
        obstacles.forEach(ob=>ctx.fillRect(ob.x,ob.y,ob.w,ob.h));
        
        // çº¢è‚‰
        stars.forEach(s=>{ if(!s.got) { ctx.drawImage(starImg,s.x,s.y,s.w,s.h); } });
        
        // ç™½å±
        coins.forEach(c=>{ ctx.drawImage(shitImg,c.x,c.y,c.w,c.h); });
        
        // æ•Œäºº
        enemies.forEach(e=>{
            if(!e.active) return;
            ctx.fillStyle = e.type==='jumper'? '#d96f4f' : (e.type==='flyer'? '#b45fd9' : '#d94f4f');
            ctx.fillRect(e.x, e.y, e.w, e.h);
            ctx.fillStyle='#f00'; ctx.fillRect(e.x, e.y-15, e.w, 8);
            ctx.fillStyle='#0f0'; ctx.fillRect(e.x, e.y-15, e.w * (e.hp/e.maxHp), 8);
        });

        // Boss
        if(boss && boss.active) {
            // ctx.fillStyle = '#8b0000';
            // ctx.fillRect(boss.x, boss.y, boss.w, boss.h);
            // // Bossçœ¼ç›
            // ctx.fillStyle = '#fff';
            // ctx.fillRect(boss.x+20, boss.y+30, 20, 20);
            // ctx.fillRect(boss.x+80, boss.y+30, 20, 20);
            // ctx.fillStyle = '#000';
            // ctx.fillRect(boss.x+25, boss.y+35, 10, 10);
            ctx.fillRect(boss.x+85, boss.y+35, 10, 10);
            // Bossè¡€æ¡
            ctx.fillStyle='#f00'; 
            ctx.fillRect(boss.x, boss.y-25, boss.w, 15);
            ctx.fillStyle='#0f0'; 
            ctx.fillRect(boss.x, boss.y-25, boss.w * (boss.hp/boss.maxHp), 15);
            ctx.drawImage(bossImg,boss.x, boss.y, boss.w, boss.h)

            // é˜¶æ®µæç¤º
            if(boss.phase === 2) {
                ctx.fillStyle = '#ff0';
                ctx.font = 'bold 20px monospace';
                ctx.fillText('å¤§ç¯å¼€å¯ç‹‚æš´æ¨¡å¼', boss.x, boss.y-40);
            }
        }

        // ç»ˆç‚¹
        ctx.fillStyle = '#c4592b'; 
        ctx.fillRect(GOAL_X, GROUND_Y-110, 25, 110);
        ctx.fillStyle = '#fad03b'; 
        ctx.fillRect(GOAL_X-5, GROUND_Y-140, 35, 35);

        // ç©å®¶
        if(player.invincible>0 && (Date.now()%200<100)) ctx.globalAlpha=0.5;
        // ctx.fillStyle = '#3e96c7'; 
        if (player.dir === 1) {
            ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
        } else {
            // å‘å·¦æ—¶ç¿»è½¬å›¾ç‰‡
            ctx.save();
            ctx.translate(player.x + player.w, player.y);
            ctx.scale(-1, 1);
            ctx.drawImage(playerImg, 0, 0, player.w, player.h);
            ctx.restore();
        }
        // ctx.drawImage(playerImg,player.x, player.y, player.w, player.h)
        // ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.globalAlpha=1;
        // æ´å­
        if(player.attacking) {
            if (player.dir === 1) {
            ctx.drawImage(handImg, player.x+player.w, player.y,hand.w, hand.h);
        } else {
            // å‘å·¦æ—¶ç¿»è½¬å›¾ç‰‡
            ctx.save();
            ctx.translate(player.x + player.w, player.y);
            ctx.scale(-1, 1);
            ctx.drawImage(handImg, player.w, 0, hand.w, hand.h);
            ctx.restore();
        }
            // ctx.drawImage(handImg,player.x+(player.dir===1? player.w: -40), player.y, 40, player.h);
        }
        ctx.restore();

        if(gameOver) { 
            ctx.font='bold 48px monospace'; 
            ctx.fillStyle='#9d2a2a'; 
            ctx.fillText('ä½ çš„äºŒç‹—ç²¾å°½è€Œäº¡äº†!', 350,250); 
        }
        requestAnimationFrame(frame);
    }
    function frame() { updateGame(); draw(); }

    // è¾“å…¥çŠ¶æ€
    let left = false, right = false, jumpKey = false;
    let gameActive = false, gameWin = false, gameOver = false;
    let difficulty = 2;
    let cameraX = 0;

    // äº‹ä»¶ç»‘å®š
    window.addEventListener('keydown', e=>{
        if(!gameActive) return;
        let k=e.key;
        if(k==='ArrowLeft'||k==='a'||k==='A') { left=true; e.preventDefault(); }
        if(k==='ArrowRight'||k==='d'||k==='D') { right=true; e.preventDefault(); }
        if(k===' '||k==='Space'||k==='ArrowUp'||k==='w'||k==='W') { e.preventDefault(); if(!jumpKey) { doJump(); jumpKey=true; } }
        if(k==='j'||k==='J') { e.preventDefault(); performAttack(); }
    });
    window.addEventListener('keyup', e=>{
        let k=e.key;
        if(k==='ArrowLeft'||k==='a'||k==='A') { left=false; e.preventDefault(); }
        if(k==='ArrowRight'||k==='d'||k==='D') { right=false; e.preventDefault(); }
        if(k===' '||k==='Space'||k==='ArrowUp'||k==='w'||k==='W') { jumpKey=false; e.preventDefault(); }
    });

    // æ‰‹æœºæŒ‰é’®
    document.getElementById('btnL').addEventListener('mousedown',e=>{e.preventDefault(); left=true;});
    document.getElementById('btnL').addEventListener('mouseup',e=>{left=false;});
    document.getElementById('btnL').addEventListener('mouseleave',e=>{left=false;});
    document.getElementById('btnL').addEventListener('touchstart',e=>{e.preventDefault(); left=true;});
    document.getElementById('btnL').addEventListener('touchend',e=>{left=false;});
    
    document.getElementById('btnR').addEventListener('mousedown',e=>{e.preventDefault(); right=true;});
    document.getElementById('btnR').addEventListener('mouseup',e=>{right=false;});
    document.getElementById('btnR').addEventListener('mouseleave',e=>{right=false;});
    document.getElementById('btnR').addEventListener('touchstart',e=>{e.preventDefault(); right=true;});
    document.getElementById('btnR').addEventListener('touchend',e=>{right=false;});
    
    document.getElementById('btnJ').addEventListener('mousedown',e=>{e.preventDefault(); doJump();});
    document.getElementById('btnJ').addEventListener('touchstart',e=>{e.preventDefault(); doJump();});
    
    document.getElementById('btnAttack').addEventListener('mousedown',e=>{e.preventDefault(); performAttack();});
    document.getElementById('btnAttack').addEventListener('touchstart',e=>{e.preventDefault(); performAttack();});
    
    document.getElementById('jumpBig').addEventListener('mousedown',e=>{e.preventDefault(); doJump();});
    document.getElementById('jumpBig').addEventListener('touchstart',e=>{e.preventDefault(); doJump();});
    
    document.getElementById('attackBig').addEventListener('mousedown',e=>{e.preventDefault(); performAttack();});
    document.getElementById('attackBig').addEventListener('touchstart',e=>{e.preventDefault(); performAttack();});

    // èœå•æ§åˆ¶
    function hideAllMenus() {
        menuOverlay.style.display = 'none';
        levelSelectOverlay.style.display = 'none';
        completionOverlay.style.display = 'none';
        shopOverlay.style.display = 'none';
        settingsOverlay.style.display = 'none';
        endingOverlay.style.display = 'none';
    }

    function showMenu() { hideAllMenus(); menuOverlay.style.display = 'flex'; }
    
    function showLevels() { 
        hideAllMenus(); 
        levelSelectOverlay.style.display = 'flex';
        
        let html = '';
        levels.forEach(level => {
            let starsDisplay = '';
            if(levelStarsCollected[level.id] > 0) {
                starsDisplay = `<span class="level-stars">â­ ${levelStarsCollected[level.id]}/${level.stars}</span>`;
            }
            html += `<button class="level-btn ${!level.unlocked ? 'locked' : ''}" 
                ${level.unlocked ? `data-level="${level.id}"` : 'disabled'}>
                ${level.id}. ${level.name}
                ${starsDisplay}
                ${level.unlocked ? '' : 'ğŸ”’'}
            </button>`;
        });
        levelButtonsDiv.innerHTML = html;
        
        document.querySelectorAll('.level-btn[data-level]').forEach(btn => {
            btn.addEventListener('click', () => {
                currentLevel = parseInt(btn.dataset.level);
                generateLevel(currentLevel);
                resetGame();
                hideAllMenus();
            });
        });
    }
    
    function showShop() { 
        hideAllMenus(); 
        shopOverlay.style.display = 'flex'; 
        shopCoinSpan.innerText = player.coins; 
    }
    
    function showSettings() { hideAllMenus(); settingsOverlay.style.display = 'flex'; }

    menuButton.addEventListener('click', showMenu);
    
    startBtn.addEventListener('click', ()=>{ 
        currentLevel = 1; 
        generateLevel(1); 
        resetGame(); 
        hideAllMenus(); 
    });
    
    levelSelectBtn.addEventListener('click', showLevels);
    shopBtnMain.addEventListener('click', showShop);
    settingsBtnMain.addEventListener('click', showSettings);
    closeMenu.addEventListener('click', hideAllMenus);
    backFromLevels.addEventListener('click', showMenu);
    backFromShop.addEventListener('click', showMenu);
    backFromSettings.addEventListener('click', showMenu);
    continueBtn.addEventListener('click', hideAllMenus);
    endingContinueBtn.addEventListener('click', ()=>{
        endingOverlay.style.display = 'none';
        showMenu();
    });

    buyHp.addEventListener('click', ()=>buyItem('hp'));
    buyAtk.addEventListener('click', ()=>buyItem('atk'));
    buyHeal.addEventListener('click', ()=>buyItem('heal'));

    difficultySelect.addEventListener('change', e=>{ difficulty = parseInt(e.target.value); });
    
    masterVolume.addEventListener('input', e=>{ 
        if(masterGain) masterGain.gain.value = e.target.value/100; 
    });
    
    sfxVolume.addEventListener('input', e=>{ 
        if(sfxGain) sfxGain.gain.value = e.target.value/100; 
    });

    restartBtn.addEventListener('click', (e) => {
        e.preventDefault();
        resetGame();
    });

    canvas.addEventListener('contextmenu', e=>e.preventDefault());
    canvas.addEventListener('touchstart', e=>e.preventDefault());

    // åˆå§‹åŒ–å‰§æƒ…
    storyIndex = 0;
    showNextStory();
    generateLevel(1);
    updateUI();
    frame();
})();
</script>
</body>
</html>