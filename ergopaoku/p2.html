<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ— å°½è·‘é…· Â· ç‰›é¡¿åŠ›å­¦ Â· è¡€é‡ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #173e4f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', 'Courier New', monospace;
        }
        .game-wrapper {
            background: #206a88;
            padding: 20px 20px 25px;
            border-radius: 50px 50px 35px 35px;
            box-shadow: 0 25px 25px rgba(0,0,0,0.8), inset 0 0 20px #b3f0ff;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 35px;
            background: #c6ecff;
            box-shadow: inset 0 -12px 0 #4e7b94, 0 18px 20px rgba(0,0,0,0.6);
            touch-action: none;
        }
        .stats-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 18px 12px 12px;
            color: #fef7dc;
            text-shadow: 4px 4px 0 #144452;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .hp-area {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #2b2020;
            padding: 8px 30px 8px 20px;
            border-radius: 60px;
            border: 3px solid #ffc9a2;
        }
        .hp-heart {
            font-size: 2rem;
            color: #ff6b6b;
            filter: drop-shadow(0 2px 2px #3a0f0f);
        }
        .star-display {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #2b4628;
            padding: 8px 30px 8px 20px;
            border-radius: 60px;
            border: 3px solid #ffe394;
        }
        .mobile-row {
            display: flex;
            gap: 35px;
            justify-content: center;
            margin: 12px 0 8px;
        }
        .mobile-row button {
            padding: 16px 45px;
            font-size: 2.4rem;
            background: #daf2ff;
            border: 4px solid #ffffdd;
            border-radius: 90px;
            box-shadow: 0 10px 0 #356f96, 0 12px 18px black;
            transition: 0.05s linear;
            touch-action: manipulation;
            font-weight: bold;
            color: #103d52;
        }
        .mobile-row button:active {
            transform: translateY(8px);
            box-shadow: 0 2px 0 #356f96, 0 8px 14px black;
        }
        .bottom-actions {
            display: flex;
            gap: 20px;
            margin-top: 18px;
        }
        .bottom-actions button {
            flex: 1;
            background: #ffe394;
            border: none;
            border-radius: 60px;
            padding: 16px 20px;
            font-size: 1.6rem;
            font-weight: bold;
            color: #124f66;
            box-shadow: 0 9px 0 #9f7e55, 0 9px 15px black;
            touch-action: manipulation;
        }
        .bottom-actions button:active {
            transform: translateY(7px);
            box-shadow: 0 2px 0 #9f7e55, 0 7px 12px black;
        }
        @media (hover: hover) and (pointer: fine) {
            .mobile-row { display: none; }
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <canvas id="gameCanvas" width="1300" height="600"></canvas>
    <div class="stats-panel">
        <div class="hp-area">
            <span class="hp-heart">â¤ï¸</span>
            <span id="hpCounter">5 / 5</span>
        </div>
        <div class="star-display">
            <span style="font-size:2rem;">â­</span>
            <span id="starCounter">0 / 12</span>
        </div>
        <div id="goalMessage" style="background:#362f1e; padding:8px 35px; border-radius:60px;">ğŸ é¥è¿œç»ˆç‚¹</div>
    </div>
    <!-- æ‰‹æœºä¸“ç”¨æŒ‰é’® (å·¦/å³/è·³) -->
    <div class="mobile-row">
        <button id="mobileLeft">â—€â—€ å·¦</button>
        <button id="mobileJump">â–² è·³</button>
        <button id="mobileRight">å³ â–¶â–¶</button>
    </div>
    <div class="bottom-actions">
        <button id="jumpBigBtn">ğŸ¦˜ è·³è·ƒ (ç©ºæ ¼/W/â†‘)</button>
        <button id="restartBtn">ğŸ”„ é‡æ–°å¼€å§‹</button>
    </div>
</div>
<script>
(function(){
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hpSpan = document.getElementById('hpCounter');
    const starSpan = document.getElementById('starCounter');
    const goalDiv = document.getElementById('goalMessage');

    // è¶…å¤§ç”»å¸ƒ & ä¸–ç•Œ (ä¸–ç•Œå®½åº¦ 8000)
    const W = 1300, H = 600;
    canvas.width = W; canvas.height = H;
    const WORLD_WIDTH = 8000;
    const GROUND_Y = H - 75;          // åœ°é¢é¡¶éƒ¨Yåæ ‡ (åœ°é¢åš75px)

    // ---------- çœŸå®ç‰›é¡¿åŠ›å­¦å‚æ•° ----------
    const GRAVITY = 0.68;              // é‡åŠ›åŠ é€Ÿåº¦ (px/frameÂ²)
    const JUMP_FORCE = -13.2;          // è·³è·ƒåˆé€Ÿåº¦ (å‘ä¸Š)
    const MOVE_FORCE = 0.9;             // æ°´å¹³åŠ é€Ÿåº¦ (åŠ›)
    const FRICTION_GROUND = 0.82;       // åœ°é¢æ‘©æ“¦åŠ› (æ¯å¸§ä¹˜æ•°)
    const AIR_RESIST = 0.985;           // ç©ºæ°”é˜»åŠ›
    const MAX_H_SPEED = 9.5;            // æœ€å¤§æ°´å¹³é€Ÿåº¦
    const MAX_V_SPEED = 18.0;            // æœ€å¤§ä¸‹è½é€Ÿåº¦

    // ç©å®¶å±æ€§ (å¸¦è¡€é‡)
    let player = {
        x: 150, y: GROUND_Y - 64,
        w: 36, h: 62,
        vx: 0, vy: 0,
        onGround: false,
        facingRight: true,
        hp: 5,
        invincible: 0,                  // å—ä¼¤æ— æ•Œå¸§æ•° (>0æ—¶æ— è§†ä¼¤å®³)
    };
    const MAX_HP = 5;

    // ---------- è¶…å¤§ä¸°å¯Œåœ°å½¢ï¼šå¹³å° Ã— 20+ï¼Œéšœç¢ç‰© Ã— 15+ ----------
    const platforms = [
        // åœ°é¢ (æ•´ä¸ªä¸–ç•Œçš„åŸºåº•)
        { x: 0, y: GROUND_Y, w: WORLD_WIDTH, h: 75, isGround: true },
        // ä½ç©ºè·³è·ƒåŒº
        { x: 400, y: 500, w: 120, h: 22 },
        { x: 750, y: 440, w: 110, h: 22 },
        { x: 1150, y: 380, w: 140, h: 22 },
        { x: 1550, y: 460, w: 100, h: 22 },
        // å¤æ‚ä¸­å±‚
        { x: 2100, y: 330, w: 130, h: 22 },
        { x: 2600, y: 270, w: 120, h: 22 },
        { x: 3050, y: 350, w: 160, h: 22 },
        { x: 3500, y: 400, w: 110, h: 22 },
        { x: 3950, y: 280, w: 140, h: 22 },
        // é«˜ç©ºæƒŠé™©åŒº (éœ€è¦ç²¾å‡†è·³è·ƒ)
        { x: 4400, y: 200, w: 90, h: 22 },
        { x: 4800, y: 130, w: 80, h: 22 },
        { x: 5150, y: 210, w: 130, h: 22 },
        { x: 5600, y: 280, w: 100, h: 22 },
        { x: 6000, y: 170, w: 110, h: 22 },
        // ç»ˆç‚¹å‰åŒºåŸŸ
        { x: 6500, y: 320, w: 150, h: 22 },
        { x: 6950, y: 380, w: 130, h: 22 },
        { x: 7350, y: 430, w: 200, h: 22 },
        { x: 7700, y: 480, w: 150, h: 22 },  // æœ€åè·³å‘ç»ˆç‚¹
    ];

    // éšœç¢ç‰© (ç¢°è§¦åæ‰£è¡€, ä¸ä¼šç«‹å³æ­»äº¡)
    const obstacles = [
        { x: 280, y: GROUND_Y - 40, w: 45, h: 40, type: 'spike' },
        { x: 900, y: GROUND_Y - 42, w: 55, h: 42, type: 'spike' },
        { x: 1300, y: 400, w: 70, h: 25, type: 'block' },   // å¹³å°ä¸Šçš„å±é™©å—
        { x: 1800, y: GROUND_Y - 45, w: 60, h: 45, type: 'spike' },
        { x: 2350, y: 280, w: 65, h: 30, type: 'spike' },    // ç©ºä¸­å°–åˆº
        { x: 2850, y: GROUND_Y - 45, w: 70, h: 45, type: 'spike' },
        { x: 3300, y: 310, w: 55, h: 25, type: 'block' },
        { x: 3800, y: GROUND_Y - 45, w: 80, h: 45, type: 'spike' },
        { x: 4200, y: 230, w: 60, h: 28, type: 'spike' },
        { x: 4650, y: 150, w: 60, h: 28, type: 'spike' },    // é«˜å°é™„è¿‘
        { x: 5000, y: 170, w: 55, h: 25, type: 'block' },
        { x: 5400, y: GROUND_Y - 45, w: 70, h: 45, type: 'spike' },
        { x: 5900, y: 130, w: 65, h: 28, type: 'spike' },
        { x: 6250, y: GROUND_Y - 45, w: 80, h: 45, type: 'spike' },
        { x: 6700, y: 280, w: 70, h: 30, type: 'spike' },
        { x: 7100, y: 340, w: 60, h: 30, type: 'block' },
        { x: 7550, y: 400, w: 60, h: 30, type: 'spike' },
    ];

    // æ”¶é›†å“ (12é¢—æ˜Ÿæ˜Ÿ)
    let collectibles = [
        { x: 200, y: GROUND_Y - 100, w: 24, h: 24, collected: false },
        { x: 550, y: 450, w: 24, h: 24, collected: false },
        { x: 950, y: 390, w: 24, h: 24, collected: false },
        { x: 1400, y: 330, w: 24, h: 24, collected: false },
        { x: 1900, y: 410, w: 24, h: 24, collected: false },
        { x: 2400, y: 220, w: 24, h: 24, collected: false },
        { x: 3000, y: 300, w: 24, h: 24, collected: false },
        { x: 3600, y: 350, w: 24, h: 24, collected: false },
        { x: 4150, y: 230, w: 24, h: 24, collected: false },
        { x: 4700, y: 150, w: 24, h: 24, collected: false },
        { x: 5400, y: 230, w: 24, h: 24, collected: false },
        { x: 6300, y: 300, w: 24, h: 24, collected: false },
        { x: 7200, y: 390, w: 24, h: 24, collected: false },
        { x: 7800, y: 440, w: 24, h: 24, collected: false },  // ç¬¬12é¢—
    ];
    const MAX_STARS = collectibles.length;

    // ç»ˆç‚¹ä½ç½®
    const GOAL_X = 7850;
    const GOAL_W = 30;

    // æ‘„åƒæœº
    let cameraX = 0;

    // è¾“å…¥çŠ¶æ€
    let leftPressed = false, rightPressed = false;
    let jumpPressed = false;          // é˜²æ­¢æŒ‰ä½è¿è·³

    // æ¸¸æˆçŠ¶æ€
    let gameActive = true;
    let gameWin = false;
    let gameOver = false;             // è¡€é‡å½’é›¶å¯¼è‡´å¤±è´¥

    // ---------- UIæ›´æ–° ----------
    function updateUI() {
        const collected = collectibles.filter(c => c.collected).length;
        starSpan.innerText = `${collected} / ${MAX_STARS}`;
        hpSpan.innerText = `${player.hp} / ${MAX_HP}`;
    }

    // é‡ç½®æ¸¸æˆ
    function resetGame() {
        gameActive = true;
        gameWin = false;
        gameOver = false;
        player = {
            x: 150, y: GROUND_Y - 64,
            w: 36, h: 62,
            vx: 0, vy: 0,
            onGround: true,
            facingRight: true,
            hp: MAX_HP,
            invincible: 0,
        };
        collectibles.forEach(c => c.collected = false);
        updateUI();
        goalDiv.innerText = 'ğŸ é¥è¿œç»ˆç‚¹';
        goalDiv.style.background = '#362f1e';
    }

    // ç©å®¶å—ä¼¤ (æ‰£è¡€ + æ— æ•Œå¸§)
    function damagePlayer(amount = 1) {
        if (!gameActive || gameWin || gameOver) return;
        if (player.invincible > 0) return;   // æ— æ•Œä¿æŠ¤

        player.hp -= amount;
        player.invincible = 35;               // çº¦0.6ç§’ (60fps)

        if (player.hp <= 0) {
            player.hp = 0;
            gameActive = false;
            gameOver = true;
            goalDiv.innerText = 'ğŸ’” åŠ›å°½è€Œäº¡...';
            goalDiv.style.background = '#a1402b';
        }
        updateUI();
    }

    // éšœç¢ç‰©ç¢°æ’æ£€æµ‹ (æ‰£è¡€)
    function checkObstacleDamage() {
        for (let ob of obstacles) {
            if (player.x < ob.x + ob.w && player.x + player.w > ob.x &&
                player.y < ob.y + ob.h && player.y + player.h > ob.y) {
                damagePlayer(1);
                // å‡»é€€æ•ˆæœ (è½»å¾®å¼¹å¼€)
                if (player.vx > 0) player.vx = -4;
                else if (player.vx < 0) player.vx = 4;
                else player.vx = (player.facingRight ? -4 : 4);
                break;  // ä¸€å¸§åªè§¦å‘ä¸€æ¬¡ä¼¤å®³
            }
        }
    }

    // ---------- ç‰›é¡¿åŠ›å­¦æ›´æ–° (åŠ›ã€åŠ é€Ÿåº¦ã€æ‘©æ“¦) ----------
    function updatePhysics() {
        if (!gameActive) return;

        // æ— æ•Œå¸§é€’å‡
        if (player.invincible > 0) player.invincible--;

        // æ°´å¹³åŠ› (å·¦å³è¾“å…¥)
        let force = 0;
        if (leftPressed) force -= MOVE_FORCE;
        if (rightPressed) force += MOVE_FORCE;
        player.vx += force;

        // æ‘©æ“¦/é˜»åŠ›
        if (player.onGround) {
            player.vx *= FRICTION_GROUND;      // åœ°é¢æ‘©æ“¦åŠ›å¤§
        } else {
            player.vx *= AIR_RESIST;            // ç©ºæ°”é˜»åŠ›å°
        }

        // é™åˆ¶æœ€å¤§æ°´å¹³é€Ÿåº¦
        if (player.vx > MAX_H_SPEED) player.vx = MAX_H_SPEED;
        else if (player.vx < -MAX_H_SPEED) player.vx = -MAX_H_SPEED;

        // è®°å½•æ—§ä½ç½® (ç¢°æ’ç”¨)
        let oldX = player.x, oldY = player.y;

        // æ°´å¹³ç§»åŠ¨ + è¾¹ç•Œé™åˆ¶
        player.x += player.vx;
        if (player.x < 10) { player.x = 10; player.vx = 0; }
        if (player.x + player.w > WORLD_WIDTH - 10) { player.x = WORLD_WIDTH - player.w - 10; player.vx = 0; }

        // é‡åŠ›åŠ é€Ÿåº¦
        player.vy += GRAVITY;
        if (player.vy > MAX_V_SPEED) player.vy = MAX_V_SPEED;
        player.y += player.vy;

        // å¹³å°ç¢°æ’ (åŸºäºåˆ†ç¦»è½´)
        player.onGround = false;
        for (let pl of platforms) {
            if (player.x < pl.x + pl.w && player.x + player.w > pl.x) {
                let pTop = player.y, pBottom = player.y + player.h;
                let platTop = pl.y, platBottom = pl.y + pl.h;

                // ä»ä¸Šæ–¹ä¸‹è½
                if (oldY + player.h <= platTop && pBottom >= platTop && player.vy >= 0) {
                    player.y = platTop - player.h;
                    player.vy = 0;
                    player.onGround = true;
                }
                // ä»ä¸‹æ–¹é¡¶å¤´
                else if (oldY >= platBottom && pTop <= platBottom && player.vy < 0) {
                    player.y = platBottom;
                    player.vy = 0;
                }
            }
        }

        // ä¿é™©: æ‰å‡ºä¸–ç•Œåº•éƒ¨
        if (player.y + player.h > GROUND_Y + 50) {
            player.y = GROUND_Y - player.h;
            player.vy = 0;
            player.onGround = true;
        }

        // éšœç¢ç‰©ä¼¤å®³æ£€æµ‹ (å¦‚æœè¿˜æ´»ç€)
        if (gameActive && !gameWin) checkObstacleDamage();

        // æ”¶é›†å“
        for (let item of collectibles) {
            if (!item.collected) {
                if (player.x < item.x + item.w && player.x + player.w > item.x &&
                    player.y < item.y + item.h && player.y + player.h > item.y) {
                    item.collected = true;
                    updateUI();
                }
            }
        }

        // ç»ˆç‚¹æ£€æµ‹
        if (!gameWin && player.x + player.w > GOAL_X) {
            gameWin = true;
            gameActive = false;   // èƒœåˆ©åå†»ç»“
            goalDiv.innerText = 'ğŸ† å¾æœè€…! æŠµè¾¾ç»ˆç‚¹ ğŸ†';
            goalDiv.style.background = '#3f9944';
        }

        // å¦‚æœè¡€é‡å½’é›¶å·²è§¦å‘gameOver, ä½†ä¸ºäº†æ˜¾ç¤ºæ›´æ–°
        if (gameOver) gameActive = false;
    }

    // è·³è·ƒ (ç¬¦åˆç‰©ç†)
    function performJump() {
        if (!gameActive) return;
        if (player.onGround) {
            player.vy = JUMP_FORCE;
            player.onGround = false;
        }
    }

    // ----- ç»˜åˆ¶ (ç›¸æœºè·Ÿéš) -----
    function draw() {
        ctx.clearRect(0, 0, W, H);

        // æ‘„åƒæœºå¹³æ»‘è·Ÿéš (ç©å®¶åœ¨ä¸­é—´åå·¦)
        let targetCam = player.x - 500;
        targetCam = Math.max(0, Math.min(targetCam, WORLD_WIDTH - W));
        cameraX = targetCam;

        ctx.save();
        ctx.translate(-cameraX, 0);

        // èƒŒæ™¯æ¸å˜
        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, '#c9ecff');
        grad.addColorStop(0.65, '#f1ddbc');
        ctx.fillStyle = grad;
        ctx.fillRect(cameraX, 0, W, H);

        // ç»˜åˆ¶æ‰€æœ‰å¹³å°
        ctx.shadowBlur = 12;
        ctx.shadowColor = '#2f3f33';
        for (let pl of platforms) {
            if (pl.isGround) {
                ctx.fillStyle = '#6a5a48';
                ctx.fillRect(pl.x, pl.y, pl.w, pl.h);
                ctx.fillStyle = '#8f9e6f';
                ctx.fillRect(pl.x, pl.y, pl.w, 14);
            } else {
                ctx.fillStyle = '#b16f3a';
                ctx.fillRect(pl.x, pl.y, pl.w, pl.h);
                ctx.fillStyle = '#dba56d';
                ctx.fillRect(pl.x, pl.y, pl.w, 8);
                // æ”¯æŸ±
                ctx.fillStyle = '#7b522e';
                ctx.fillRect(pl.x+20, pl.y+pl.h, 15, 22);
                ctx.fillRect(pl.x+pl.w-40, pl.y+pl.h, 15, 22);
            }
        }

        // éšœç¢ç‰© (å°–åˆº/æ–¹å—)
        for (let ob of obstacles) {
            if (ob.type === 'spike') {
                ctx.fillStyle = '#c04242';
                for (let i=0; i<6; i++) {
                    let sx = ob.x + i*(ob.w/6);
                    ctx.beginPath();
                    ctx.moveTo(sx, ob.y+ob.h);
                    ctx.lineTo(sx+ob.w/12, ob.y);
                    ctx.lineTo(sx+ob.w/6, ob.y+ob.h);
                    ctx.fill();
                }
            } else {
                ctx.fillStyle = '#8b5e3c';
                ctx.fillRect(ob.x, ob.y, ob.w, ob.h);
                ctx.fillStyle = '#c4945e';
                ctx.fillRect(ob.x+8, ob.y+4, ob.w-16, 8);
            }
        }

        // æ˜Ÿæ˜Ÿ (æ›´äº®)
        for (let item of collectibles) {
            if (!item.collected) {
                ctx.shadowBlur = 26;
                ctx.shadowColor = '#ffde5c';
                ctx.fillStyle = '#ffd966';
                ctx.beginPath();
                ctx.arc(item.x+12, item.y+12, 14, 0, 2*Math.PI);
                ctx.fill();
                ctx.fillStyle = '#f0b300';
                ctx.beginPath();
                ctx.arc(item.x+6, item.y+6, 6, 0, 2*Math.PI);
                ctx.fill();
            }
        }

        // ç»ˆç‚¹é—¨
        ctx.shadowColor = '#2f8b2f';
        ctx.shadowBlur = 18;
        ctx.fillStyle = '#bf4d4d';
        ctx.fillRect(GOAL_X, GROUND_Y-170, 35, 170);
        ctx.fillStyle = '#f5cb5c';
        ctx.beginPath();
        ctx.moveTo(GOAL_X+35, GROUND_Y-170);
        ctx.lineTo(GOAL_X+95, GROUND_Y-130);
        ctx.lineTo(GOAL_X+35, GROUND_Y-90);
        ctx.fill();
        ctx.font = 'bold 48px "Courier New"';
        ctx.fillStyle = '#367a29';
        ctx.fillText('ğŸ', GOAL_X-10, GROUND_Y-200);

        // ç©å®¶ (æ— æ•Œé—ªçƒ)
        if (player.invincible > 0 && (Math.floor(Date.now()/150)%2 === 0)) {
            ctx.fillStyle = '#ffffff';   // é—ªçƒç™½
        } else {
            ctx.fillStyle = '#3587a3';
        }
        ctx.shadowBlur = 18;
        ctx.shadowColor = '#2b5f7a';
        ctx.beginPath();
        ctx.roundRect(player.x, player.y, player.w, player.h, 12);
        ctx.fill();
        // èƒŒåŒ…
        ctx.fillStyle = '#1d5a73';
        ctx.fillRect(player.x-8, player.y+18, 8, 28);
        // æŠ¤ç›®é•œ
        ctx.fillStyle = '#f5c542';
        ctx.beginPath();
        ctx.arc(player.x+26, player.y+20, 9, 0, 2*Math.PI);
        ctx.fill();
        ctx.fillStyle = '#111';
        ctx.beginPath();
        ctx.arc(player.x+28, player.y+20, 5, 0, 2*Math.PI);
        ctx.fill();

        ctx.restore();

        // HUDé¢å¤–ä¿¡æ¯
        ctx.font = 'bold 28px "Segoe UI"';
        ctx.fillStyle = '#022b36';
        ctx.shadowBlur = 12;
        ctx.shadowColor = '#b6e6ff';
        ctx.fillText(`ğŸ“ ${Math.floor(player.x)}m`, 1000, 70);
        if (gameOver) {
            ctx.font = 'bold 60px sans-serif';
            ctx.fillStyle = '#b3341c';
            ctx.fillText('GAME OVER', 300, 300);
        } else if (gameWin) {
            ctx.font = 'bold 56px sans-serif';
            ctx.fillStyle = '#1f8430';
            ctx.fillText('VICTORY', 380, 300);
        }

        requestAnimationFrame(frame);
    }

    function frame() {
        updatePhysics();
        draw();
    }

    // ----- äº‹ä»¶ç»‘å®š (é”®ç›˜ + æ‰‹æœº) -----
    function keydown(e) {
        const k = e.key;
        if (!gameActive) { e.preventDefault(); return; }
        if (k === 'ArrowLeft' || k === 'a' || k === 'A') { leftPressed = true; e.preventDefault(); }
        if (k === 'ArrowRight' || k === 'd' || k === 'D') { rightPressed = true; e.preventDefault(); }
        if (k === ' ' || k === 'Space' || k === 'ArrowUp' || k === 'w' || k === 'W') {
            e.preventDefault();
            if (!jumpPressed) {
                performJump();
                jumpPressed = true;
            }
        }
    }
    function keyup(e) {
        const k = e.key;
        if (k === 'ArrowLeft' || k === 'a' || k === 'A') { leftPressed = false; e.preventDefault(); }
        if (k === 'ArrowRight' || k === 'd' || k === 'D') { rightPressed = false; e.preventDefault(); }
        if (k === ' ' || k === 'Space' || k === 'ArrowUp' || k === 'w' || k === 'W') {
            jumpPressed = false;
            e.preventDefault();
        }
    }
    window.addEventListener('keydown', keydown);
    window.addEventListener('keyup', keyup);

    // æ‰‹æœºæŒ‰é’®
    const leftM = document.getElementById('mobileLeft');
    const rightM = document.getElementById('mobileRight');
    const jumpM = document.getElementById('mobileJump');
    const jumpBig = document.getElementById('jumpBigBtn');
    const restartBtn = document.getElementById('restartBtn');

    function startL(e) { e.preventDefault(); leftPressed = true; }
    function stopL(e) { leftPressed = false; }
    function startR(e) { e.preventDefault(); rightPressed = true; }
    function stopR(e) { rightPressed = false; }
    function jumpHandler(e) { e.preventDefault(); performJump(); }

    leftM.addEventListener('mousedown', startL);
    leftM.addEventListener('mouseup', stopL);
    leftM.addEventListener('mouseleave', stopL);
    leftM.addEventListener('touchstart', startL, {passive:false});
    leftM.addEventListener('touchend', stopL);
    leftM.addEventListener('touchcancel', stopL);

    rightM.addEventListener('mousedown', startR);
    rightM.addEventListener('mouseup', stopR);
    rightM.addEventListener('mouseleave', stopR);
    rightM.addEventListener('touchstart', startR, {passive:false});
    rightM.addEventListener('touchend', stopR);
    rightM.addEventListener('touchcancel', stopR);

    jumpM.addEventListener('mousedown', jumpHandler);
    jumpM.addEventListener('touchstart', jumpHandler, {passive:false});
    jumpBig.addEventListener('mousedown', jumpHandler);
    jumpBig.addEventListener('touchstart', jumpHandler, {passive:false});

    restartBtn.addEventListener('click', (e) => { e.preventDefault(); resetGame(); });
    restartBtn.addEventListener('touchstart', (e) => { e.preventDefault(); resetGame(); });

    canvas.addEventListener('contextmenu', e => e.preventDefault());
    canvas.addEventListener('touchstart', e => e.preventDefault());

    // å¯åŠ¨
    resetGame();
    frame();
})();
</script>
</body>
</html>