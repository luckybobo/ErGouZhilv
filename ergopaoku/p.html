<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç®€çº¦è·‘é…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #2b4f5e;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
        }
        .game-box {
            background: #4d7b8f;
            padding: 15px;
            border-radius: 32px;
            box-shadow: 0 15px 20px rgba(0,0,0,0.6);
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 24px;
            background: #b0d1e4;
            box-shadow: inset 0 -5px 0 #4e6b7a, 0 10px 10px rgba(0,0,0,0.4);
            touch-action: none;
        }
        .panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 5px 5px;
            color: #f0e6c5;
            text-shadow: 2px 2px 0 #1a3a47;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .hp-block {
            background: #392e2e;
            padding: 5px 18px;
            border-radius: 40px;
            border: 2px solid #ffba7a;
        }
        .star-block {
            background: #2b482b;
            padding: 5px 18px;
            border-radius: 40px;
            border: 2px solid #ffe28a;
        }
        .mobile-ctrls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 10px 0 5px;
        }
        .mobile-ctrls button {
            padding: 10px 30px;
            font-size: 2rem;
            background: #d6ecff;
            border: 3px solid #fff8cf;
            border-radius: 60px;
            box-shadow: 0 7px 0 #386882, 0 8px 12px black;
            transition: 0.03s linear;
            touch-action: manipulation;
            font-weight: bold;
            color: #173e51;
        }
        .mobile-ctrls button:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #386882, 0 6px 10px black;
        }
        .bottom-btns {
            display: flex;
            gap: 15px;
            margin-top: 12px;
        }
        .bottom-btns button {
            flex: 1;
            background: #f5cf8b;
            border: none;
            border-radius: 40px;
            padding: 12px 10px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #194455;
            box-shadow: 0 6px 0 #8b6d44, 0 7px 12px black;
            touch-action: manipulation;
        }
        .bottom-btns button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #8b6d44, 0 6px 10px black;
        }
        @media (hover: hover) and (pointer: fine) {
            .mobile-ctrls { display: none; }
        }
        .image-note {
            color: #ffd966;
            font-size: 0.9rem;
            margin-top: 8px;
            text-align: center;
            background: #1d4455;
            padding: 4px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
<div class="game-box">
    <canvas id="gameCanvas" width="1000" height="450"></canvas>
    <div class="panel">
        <div class="hp-block"><span id="hpDisplay">â¤ï¸ 5 / 5</span></div>
        <div class="star-block"><span id="starDisplay">â­ 0 / 8</span></div>
        <div id="msgBox" style="background:#352d1a; padding:5px 25px; border-radius:40px;">äºŒä¸ƒ â†’</div>
    </div>
    <!-- æ‰‹æœºæŒ‰é’® (å·¦/å³/è·³) -->
    <div class="mobile-ctrls">
        <button id="btnLeft">â—€ å·¦</button>
        <button id="btnJump">â–² äºŒæ®µè·³</button>
        <button id="btnRight">å³ â–¶</button>
    </div>
    <div class="bottom-btns">
        <button id="jumpBig">äºŒæ®µè·³</button>
        <button id="restartGame">é‡æ–°æ¥è¿‡</button>
    </div>
    <div class="image-note">
        ä½ èƒ½è®©äºŒç‹—èº²è¿‡é˜¿åŠ›çš„è¿½æ€å¹¶æŠµè¾¾äºŒä¸ƒå—ï¼Ÿå¿«æ¥è¯•è¯•å§
    </div>
</div>
<script>
(function(){
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hpSpan = document.getElementById('hpDisplay');
    const starSpan = document.getElementById('starDisplay');
    const msgBox = document.getElementById('msgBox');

    // ---------- å›ºå®šå°ºå¯¸ ----------
    const W = 1000, H = 450;
    canvas.width = W; canvas.height = H;
    const WORLD_WIDTH = 5000;          // ä¸–ç•Œæ€»é•¿åº¦
    const GROUND_Y = H - 58;            // åœ°é¢é¡¶éƒ¨

    // ---------- æç®€å‚æ•° ----------
    const GRAVITY = 0.6;
    const JUMP_FORCE = -11;
    const DOUBLE_JUMP_FORCE = -9.5;
    const MOVE_SPEED = 4.8;              // ç›´æ¥é€Ÿåº¦ï¼Œæ— æƒ¯æ€§(æ›´ç®€å•)
    const MAX_FALL = 14;

    // ç©å®¶ç»“æ„
    let player = {
        x: 120, y: GROUND_Y - 50,
        w: 50, h: 50,
        vx: 0, vy: 0,
        onGround: false,
        doubleJumpUsed: false,
        dir: 1,                // 1=å³, -1=å·¦
        hp: 5,
        invincible: 0
    };
    const MAX_HP = 5;

    // æ”¶é›†å“ (æ˜Ÿæ˜Ÿ) 8ä¸ª
    let stars = [
        { x: 300, y: GROUND_Y-80, w: 20, h: 20, got: false },
        { x: 800, y: GROUND_Y-95, w: 20, h: 20, got: false },
        { x: 1400, y: 300, w: 20, h: 20, got: false },
        { x: 2100, y: 260, w: 20, h: 20, got: false },
        { x: 2800, y: 320, w: 20, h: 20, got: false },
        { x: 3500, y: 210, w: 20, h: 20, got: false },
        { x: 4200, y: 280, w: 20, h: 20, got: false },
        { x: 4700, y: GROUND_Y-90, w: 20, h: 20, got: false }
    ];
    const TOTAL_STARS = stars.length;

    // ---------- å¯æ´»åŠ¨çš„æ•Œäºº (ç®€å•å·¦å³ç§»åŠ¨) ----------
    let enemies = [
        { x: 600, y: GROUND_Y-55, w: 32, h: 42, dir: 1, speed: 1.2, active: true },
        { x: 1600, y: GROUND_Y-55, w: 32, h: 42, dir: -1, speed: 1.5, active: true },
        { x: 2500, y: 290, w: 30, h: 38, dir: 1, speed: 1.8, active: true },   // ç©ºä¸­å¹³å°æ•Œäºº
        { x: 3300, y: GROUND_Y-55, w: 32, h: 42, dir: -1, speed: 1.3, active: true },
        { x: 4000, y: 240, w: 30, h: 38, dir: 1, speed: 2.0, active: true },
        { x: 4600, y: GROUND_Y-55, w: 32, h: 42, dir: 1, speed: 1.2, active: true }
    ];

    // å¹³å° (æç®€ç°å—)
    const platforms = [
        { x: 0, y: GROUND_Y, w: WORLD_WIDTH, h: 58 },  // åœ°é¢
        { x: 450, y: 360, w: 90, h: 18 },
        { x: 900, y: 310, w: 100, h: 18 },
        { x: 1350, y: 270, w: 110, h: 18 },
        { x: 1850, y: 320, w: 90, h: 18 },
        { x: 2350, y: 250, w: 130, h: 18 },
        { x: 2950, y: 290, w: 100, h: 18 },
        { x: 3450, y: 200, w: 100, h: 18 },
        { x: 3900, y: 260, w: 120, h: 18 },
        { x: 4350, y: 320, w: 110, h: 18 },
        { x: 4750, y: 370, w: 150, h: 18 }
    ];

    // ç»ˆç‚¹
    const GOAL_X = 4880;
    const GOAL_W = 25;

    // æ‘„åƒæœº
    let cameraX = 0;

    // æŒ‰é”®çŠ¶æ€
    let left = false, right = false, jumpKey = false;

    // æ¸¸æˆçŠ¶æ€
    let gameActive = true, gameWin = false, gameOver = false;

    function createPlayerImage() {
        const offCanvas = document.createElement('canvas');
        offCanvas.width = 30;
        offCanvas.height = 48;
        const offCtx = offCanvas.getContext('2d');
        
        // èº«ä½“
        offCtx.fillStyle = '#3e96c7';
        offCtx.fillRect(0, 0, 30, 48);
        // çœ¼ç›
        offCtx.fillStyle = '#fff';
        offCtx.fillRect(18, 12, 6, 6);
        offCtx.fillStyle = '#000';
        offCtx.fillRect(20, 14, 3, 3);
        // èƒŒåŒ…
        offCtx.fillStyle = '#2d7a9e';
        offCtx.fillRect(25, 15, 5, 20);
        
        return offCanvas;
    }
    
    function createEnemyImage() {
        const offCanvas = document.createElement('canvas');
        offCanvas.width = 32;
        offCanvas.height = 42;
        const offCtx = offCanvas.getContext('2d');
        
        // èº«ä½“
        offCtx.fillStyle = '#d94f4f';
        offCtx.fillRect(0, 0, 32, 42);
        // çœ¼ç›
        offCtx.fillStyle = '#fff';
        offCtx.fillRect(6, 8, 6, 6);
        offCtx.fillRect(18, 8, 6, 6);
        offCtx.fillStyle = '#000';
        offCtx.fillRect(8, 10, 3, 3);
        offCtx.fillRect(20, 10, 3, 3);
        // ç‰™é½¿
        offCtx.fillStyle = '#fff';
        offCtx.fillRect(10, 25, 3, 5);
        offCtx.fillRect(18, 25, 3, 5);
        
        return offCanvas;
    }
    
    // åˆ›å»ºæ˜Ÿæ˜Ÿå›¾ç‰‡
    function createStarImage() {
        const offCanvas = document.createElement('canvas');
        offCanvas.width = 20;
        offCanvas.height = 20;
        const offCtx = offCanvas.getContext('2d');
        
        offCtx.fillStyle = '#f5d742';
        offCtx.shadowBlur = 5;
        offCtx.shadowColor = '#e5b800';
        offCtx.beginPath();
        offCtx.arc(10, 10, 8, 0, 2 * Math.PI);
        offCtx.fill();
        
        return offCanvas;
    }
    
    // ç”Ÿæˆå›¾ç‰‡å¯¹è±¡
    // const playerImg = createPlayerImage();
    const enemyImg = createEnemyImage();
    const starImg = createStarImage();
    
    const playerImg = new Image();
    playerImg.src = 'ergo.png';
    
    // const enemyImg = new Image();
    // enemyImg.src = 'path/to/your/enemy.png';
    
    let imagesLoaded = 0;
    function checkImagesLoaded() {
        imagesLoaded++;
        if (imagesLoaded === 2) {
            resetAll();
            frame();
        }
    }
    playerImg.onload = checkImagesLoaded;
    enemyImg.onload = checkImagesLoaded;

    // ---------- è¾…åŠ©å‡½æ•° ----------
    function updateDisplay() {
        let collected = stars.filter(s => s.got).length;
        starSpan.innerText = `â­ ${collected} / ${TOTAL_STARS}`;
        hpSpan.innerText = `â¤ï¸ ${player.hp} / ${MAX_HP}`;
    }

    function resetAll() {
        gameActive = true;
        gameWin = false;
        gameOver = false;
        player = {
            x: 120, y: GROUND_Y - 50,
            w: 60, h: 60,
            vx: 0, vy: 0,
            onGround: false,
            doubleJumpUsed: false,
            dir: 1,
            hp: MAX_HP,
            invincible: 0
        };
        stars.forEach(s => s.got = false);
        // é‡ç½®æ•Œäººä½ç½®
        enemies = [
            { x: 600, y: GROUND_Y-55, w: 32, h: 42, dir: 1, speed: 1.2, active: true },
            { x: 1600, y: GROUND_Y-55, w: 32, h: 42, dir: -1, speed: 1.5, active: true },
            { x: 2500, y: 290, w: 30, h: 38, dir: 1, speed: 1.8, active: true },
            { x: 3300, y: GROUND_Y-55, w: 32, h: 42, dir: -1, speed: 1.3, active: true },
            { x: 4000, y: 240, w: 30, h: 38, dir: 1, speed: 2.0, active: true },
            { x: 4600, y: GROUND_Y-55, w: 32, h: 42, dir: 1, speed: 1.2, active: true }
        ];
        updateDisplay();
        msgBox.innerText = 'äºŒä¸ƒ â†’';
        msgBox.style.background = '#352d1a';
    }

    // ç©å®¶å—ä¼¤
    function hurt(dmg=1) {
        if (!gameActive || player.invincible > 0) return;
        player.hp -= dmg;
        player.invincible = 35;   // æ— æ•Œå¸§
        if (player.hp <= 0) {
            player.hp = 0;
            gameActive = false;
            gameOver = true;
            msgBox.innerText = 'ğŸ’€ ä½ æ²¡èƒ½æŠµè¾¾äºŒä¸ƒ';
            msgBox.style.background = '#962d2d';
        }
        updateDisplay();
    }

    // äºŒæ®µè·³é€»è¾‘
    function doJump() {
        if (!gameActive) return;
        if (player.onGround) {
            player.vy = JUMP_FORCE;
            player.onGround = false;
            player.doubleJumpUsed = false;
        } else {
            if (!player.doubleJumpUsed) {
                player.vy = DOUBLE_JUMP_FORCE;
                player.doubleJumpUsed = true;
            }
        }
    }

    // æ›´æ–°æ•Œäººç§»åŠ¨ (ç®€å•å·¦å³)
    function updateEnemies() {
        for (let e of enemies) {
            if (!e.active) continue;
            e.x += e.speed * e.dir;
            // è¾¹ç•Œåå¼¹ (å·¦å³é™ä½)
            if (e.x < 100 || e.x > WORLD_WIDTH - 100) e.dir *= -1;
            // ä¸å¹³å°ç²—ç•¥ç»‘å®š: ä¸ç©¿è¿‡åœ°é¢
            if (e.y > GROUND_Y - e.h) e.y = GROUND_Y - e.h;
        }
    }

    // æ•Œäººä¸ç©å®¶ç¢°æ’ (ä¼¤å®³)
    function checkEnemyCollision() {
        for (let e of enemies) {
            if (!e.active) continue;
            if (player.x < e.x + e.w && player.x + player.w > e.x &&
                player.y < e.y + e.h && player.y + player.h > e.y) {
                hurt(1);
                // è½»å¾®å‡»é€€
                if (player.x < e.x) player.vx = -5;
                else player.vx = 5;
                break;
            }
        }
    }

    // ç‰©ç†æ›´æ–°
    function updateGame() {
        if (!gameActive) return;
        if (player.invincible > 0) player.invincible--;
        if (left) { player.vx = -MOVE_SPEED; player.dir = -1; }
        else if (right) { player.vx = MOVE_SPEED; player.dir = 1; }
        else player.vx = 0;

        // ç§»åŠ¨ + è¾¹ç•Œ
        player.x += player.vx;
        if (player.x < 10) player.x = 10;
        if (player.x + player.w > WORLD_WIDTH - 10) player.x = WORLD_WIDTH - player.w - 10;

        // é‡åŠ›
        player.vy += GRAVITY;
        if (player.vy > MAX_FALL) player.vy = MAX_FALL;
        player.y += player.vy;

        // å¹³å°ç¢°æ’ (æç®€)
        player.onGround = false;
        for (let pl of platforms) {
            if (player.x < pl.x + pl.w && player.x + player.w > pl.x) {
                let pBot = player.y + player.h;
                if (pBot >= pl.y && pBot <= pl.y + pl.h + 5 && player.vy >= 0) {
                    player.y = pl.y - player.h;
                    player.vy = 0;
                    player.onGround = true;
                    player.doubleJumpUsed = false;   // è½åœ°é‡ç½®äºŒæ®µè·³
                }
            }
        }

        // é˜²æ‰å‡ºä¸–ç•Œ
        if (player.y + player.h > GROUND_Y + 20) {
            player.y = GROUND_Y - player.h;
            player.vy = 0;
            player.onGround = true;
            player.doubleJumpUsed = false;
        }

        // æ•Œäººç§»åŠ¨
        updateEnemies();

        // æ•Œäººä¼¤å®³æ£€æµ‹
        checkEnemyCollision();

        // æ”¶é›†æ˜Ÿæ˜Ÿ
        for (let s of stars) {
            if (!s.got) {
                if (player.x < s.x + s.w && player.x + player.w > s.x &&
                    player.y < s.y + s.h && player.y + player.h > s.y) {
                    s.got = true;
                    updateDisplay();
                }
            }
        }

        // ç»ˆç‚¹
        if (!gameWin && player.x + player.w > GOAL_X) {
            gameWin = true;
            gameActive = false;
            msgBox.innerText = 'ğŸ‰ æ­å–œä½ æŠµè¾¾äº†äºŒä¸ƒ!';
            msgBox.style.background = '#3e8547';
        }
    }

    // ---------- ç»˜åˆ¶ (ä½¿ç”¨drawImageæ›¿æ¢æ–¹å—) ----------
    function draw() {
        ctx.clearRect(0, 0, W, H);

        // ç›¸æœº
        let targetCam = player.x - 400;
        targetCam = Math.max(0, Math.min(targetCam, WORLD_WIDTH - W));
        cameraX = targetCam;
        ctx.save();
        ctx.translate(-cameraX, 0);

        // èƒŒæ™¯ (ç®€å•å¤©è“)
        ctx.fillStyle = '#aad4f0';
        ctx.fillRect(cameraX, 0, W, H);

        // å¹³å° (ç°è‰²)
        ctx.fillStyle = '#6f8f9f';
        for (let pl of platforms) {
            ctx.fillRect(pl.x, pl.y, pl.w, pl.h);
            ctx.fillStyle = '#8fb0c0';
            ctx.fillRect(pl.x, pl.y, pl.w, 4);
            ctx.fillStyle = '#6f8f9f';
        }

        // æ˜Ÿæ˜Ÿ - ä½¿ç”¨drawImageç»˜åˆ¶å›¾ç‰‡
        for (let s of stars) {
            if (!s.got) {
                // ä½¿ç”¨drawImageç»˜åˆ¶æ˜Ÿæ˜Ÿå›¾ç‰‡
                ctx.drawImage(starImg, s.x, s.y, s.w, s.h);
            }
        }

        // æ•Œäºº - ä½¿ç”¨drawImageç»˜åˆ¶å›¾ç‰‡
        for (let e of enemies) {
            if (!e.active) continue;
            // æ— æ•Œé—ªçƒæ•ˆæœ (å¦‚æœæ˜¯ç©å®¶å—ä¼¤é—ªçƒï¼Œæ•Œäººä¸å˜)
            ctx.drawImage(enemyImg, e.x, e.y, e.w, e.h);
        }

        // ç»ˆç‚¹ (ç®€å•é—¨)
        ctx.fillStyle = '#c4592b';
        ctx.fillRect(GOAL_X, GROUND_Y-100, 20, 100);
        ctx.fillStyle = '#fad03b';
        ctx.fillRect(GOAL_X-5, GROUND_Y-130, 30, 30);

        // ç©å®¶
        if (player.invincible > 0 && (Math.floor(Date.now()/150)%2===0)) {
            ctx.globalAlpha = 0.5;  // åŠé€æ˜è¡¨ç¤ºæ— æ•Œ
        }
        // æ ¹æ®æœå‘ç»˜åˆ¶ (å¦‚æœéœ€è¦ç¿»è½¬å›¾ç‰‡)
        if (player.dir === 1) {
            ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
        } else {
            // å‘å·¦æ—¶ç¿»è½¬å›¾ç‰‡
            ctx.save();
            ctx.translate(player.x + player.w, player.y);
            ctx.scale(-1, 1);
            ctx.drawImage(playerImg, 0, 0, player.w, player.h);
            ctx.restore();
        }
        ctx.globalAlpha = 1.0;
        
        // äºŒæ®µè·³æŒ‡ç¤º (å°ç¿…è†€)
        if (!player.onGround && !player.doubleJumpUsed) {
            ctx.fillStyle = '#f5e56b';
            ctx.fillRect(player.x-8, player.y+10, 6, 12);
            ctx.fillRect(player.x+player.w+2, player.y+10, 6, 12);
        }

        ctx.restore();

        // HUD æ–‡å­—
        ctx.font = 'bold 22px "Courier New"';
        ctx.fillStyle = '#143b47';
        ctx.fillText(`ğŸš© ${Math.floor(player.x)}`, 800, 60);
        if (gameOver) {
            ctx.font = 'bold 48px sans-serif';
            ctx.fillStyle = '#9d2a2a';
            ctx.fillText('ä½ çš„äºŒç‹—ç²¾å°½è€Œäº¡äº†!', 250, 220);
        }

        requestAnimationFrame(frame);
    }

    function frame() {
        updateGame();
        draw();
    }

    // ---------- äº‹ä»¶ç»‘å®š ----------
    function handleKeyDown(e) {
        const k = e.key;
        if (!gameActive) return;
        if (k === 'ArrowLeft' || k === 'a' || k === 'A') { left = true; e.preventDefault(); }
        if (k === 'ArrowRight' || k === 'd' || k === 'D') { right = true; e.preventDefault(); }
        if (k === ' ' || k === 'Space' || k === 'ArrowUp' || k === 'w' || k === 'W') {
            e.preventDefault();
            if (!jumpKey) { doJump(); jumpKey = true; }
        }
    }
    function handleKeyUp(e) {
        const k = e.key;
        if (k === 'ArrowLeft' || k === 'a' || k === 'A') { left = false; e.preventDefault(); }
        if (k === 'ArrowRight' || k === 'd' || k === 'D') { right = false; e.preventDefault(); }
        if (k === ' ' || k === 'Space' || k === 'ArrowUp' || k === 'w' || k === 'W') {
            jumpKey = false; e.preventDefault();
        }
    }
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    // æ‰‹æœºæŒ‰é’®
    const btnL = document.getElementById('btnLeft');
    const btnR = document.getElementById('btnRight');
    const btnJ = document.getElementById('btnJump');
    const jumpBig = document.getElementById('jumpBig');
    const restartBtn = document.getElementById('restartGame');

    function startL(e) { e.preventDefault(); left = true; }
    function stopL(e) { left = false; }
    function startR(e) { e.preventDefault(); right = true; }
    function stopR(e) { right = false; }
    function jumpHandler(e) { e.preventDefault(); doJump(); }

    btnL.addEventListener('mousedown', startL);
    btnL.addEventListener('mouseup', stopL);
    btnL.addEventListener('mouseleave', stopL);
    btnL.addEventListener('touchstart', startL, {passive:false});
    btnL.addEventListener('touchend', stopL);

    btnR.addEventListener('mousedown', startR);
    btnR.addEventListener('mouseup', stopR);
    btnR.addEventListener('mouseleave', stopR);
    btnR.addEventListener('touchstart', startR, {passive:false});
    btnR.addEventListener('touchend', stopR);

    btnJ.addEventListener('mousedown', jumpHandler);
    btnJ.addEventListener('touchstart', jumpHandler, {passive:false});
    jumpBig.addEventListener('mousedown', jumpHandler);
    jumpBig.addEventListener('touchstart', jumpHandler, {passive:false});

    restartBtn.addEventListener('click', (e) => { e.preventDefault(); resetAll(); });
    restartBtn.addEventListener('touchstart', (e) => { e.preventDefault(); resetAll(); });

    canvas.addEventListener('contextmenu', e => e.preventDefault());
    canvas.addEventListener('touchstart', e => e.preventDefault());

    // åˆå§‹åŒ–
    resetAll();
    frame();
})();
</script>
</body>
</html>